<!DOCTYPE html>
</html>
<head>
    <title>Moving Cost Estimator</title>
    <meta name="viewport" content="width=device-width,height=device-height,minimum-scale=1,maximum-scale=1"/>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
    <link rel="stylesheet" href="css/index.css" /> 
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
    <script src="js/index.js"></script>
    <script src="js/basic-nav.js"></script>    
    <script src="js/room_info.js"></script>
    <script type="text/javascript"></script>
    
    <script>

var 
      listing_text =[]
     ,gl_item_room_id_collector = []
     ,gl_amt_volume = 0
;

        
/**
* f_set_checkbox_articles :
* create
*
* in : []
* out:
**/
function f_set_checkbox_articles(ckbx_to_create) 
{
    for (var  j = 0; j < ckbx_to_create.length ; j++)
    {      
       var
           tmp_ckbx_id="get-amt-"+ckbx_to_create[j].item_room_id
          ,dropDown = document.getElementById(tmp_ckbx_id)
       ;
        
        for (var i=0; i<=20; i++) 
        {
            var listItem = document.createElement("option");
            listItem.text = i;
            listItem.value = i;
            dropDown.appendChild(listItem);
        }
    }
}

        
//
function f_cal_set_amount()
{
    var tmp_volume = 0;
    
    for(var i_item_runner = 0; i_item_runner < gl_item_room_id_collector.length; i_item_runner++)
    {
        tmp_volume += gl_item_room_id_collector[i_item_runner].volume;
    }

    gl_amt_volume = tmp_volume;
    
    $(".total-amt").html(parseFloat(tmp_volume).toFixed(2)); 
}

//        
function f_btn_ok_popup(item_room_id)
{
    var 
         drp = document.getElementById("get-amt-"+item_room_id)
        ,number_of_items =  drp.options[ drp.options.selectedIndex ].value
        ,founded = false
        ,i_item = 0
    ;
    
    while ((!founded) && (i_item < gl_item_room_id_collector.length))
    {
        if((!founded) && (gl_item_room_id_collector[i_item].item_room_id == item_room_id))
        {
            var 
                item_volume = parseFloat(gl_item_room_id_collector[i_item].item_volume)
               ,item_amount = parseFloat((item_volume * number_of_items))
            ;

            gl_item_room_id_collector[i_item].volume = item_amount;

            $("#popup-num-rooms-"+item_room_id).popup("close"); 
            $("#vol-"+ item_room_id).html("Volume:  "+parseFloat(item_amount).toFixed(2));
            $("#amt-"+ item_room_id).html("Amount:  "+parseFloat(number_of_items).toFixed(2));

            f_cal_set_amount();
			if(number_of_items == 0)
			{
				$("#label-"+item_room_id).addClass('ui-checkbox-off');
				$("#label-"+item_room_id).removeClass('ui-checkbox-on');
				document.getElementById('checkbox-'+item_room_id).checked = false;
			}
			else 
			{
				var add_list = gl_item_room_id_collector[i_item].item_name + " ("+number_of_items+")";
				listing_text.push({ "id": item_room_id, "list": add_list});
				
				document.getElementById("listing").value = "";
				for(var i=0; i<listing_text.length; i++) 
				{
					document.getElementById("listing").value += listing_text[i].list + "\n";
					console.log("1: " + listing_text[i].list);
				}
				$('#amt-vol').addClass('hasAmount');
			}
            founded = true;
        }
        i_item++
    }
}
       
        
        
        
function f_checkbox_articles(item_room_id) 
{
    if($("#checkbox-"+item_room_id).is(":checked")) 
    { 
        $("#popup-num-rooms-"+item_room_id).popup("open");
    }
    else
    {
        var   
           founded = false
          ,i_item = 0
        ;

        
        while ((!founded) && (i_item < gl_item_room_id_collector.length))
        {
            if ((!founded) && (gl_item_room_id_collector[i_item].item_room_id == item_room_id))
            {
                var 
                     find_item = false
                    ,l_run_item = 0
                ;
                
                gl_item_room_id_collector[i_item].volume = 0;
                
                f_cal_set_amount();

                $("#amt-"+ item_room_id).html("Amount: 0.00");
                $("#vol-"+ item_room_id).html("Volume: 0.00");
                
                founded = true;
            }
            
            for(var i=0; i<listing_text.length; i++) 
            {
                if(listing_text[i].id == item_room_id)
                {
                    listing_text.splice(i, 1);
                    console.log(i + " :: " + listing_text);
                }
            }
            
            document.getElementById("listing").value = "";
            
            for(var i=0; i<listing_text.length; i++) 
            {
                document.getElementById("listing").value += listing_text[i].list + "\n";
                console.log("1: " + listing_text[i].list);
            }
            
            i_item++;
        }
    } // else
}



function f_create_room_pages()
{
    var 
         rooms = 0
        ,arrRooms1 = JSON.parse(localStorage.getItem('room'))
        ,number_of_total_rooms = gl_room_info.length
        ,rooms_to_create = []
    ;
    
    
    /*run thru all chapters*/
    for (i_rooms = 0; i_rooms < number_of_total_rooms ; i_rooms++) 
    {
        var  
             crnt_room = gl_room_info[i_rooms].room_id
            ,rooms_to_create = arrRooms1[crnt_room]
        ;

       if(rooms_to_create)
       {
            var j_room = 1;

            for(j_room; j_room <= rooms_to_create; j_room++) 
            {      
                 var newPage = $("<div data-role=page data-url=room-" +crnt_room+ "_" +j_room+ ">\n"+
                                     "<div data-role=header data-theme=b data-position=fixed data-id=footer>\n"+
                                        "<p class=header-checklist>Volume calculator and checklist</p>\n"+
                                        "<p id=amount-" +crnt_room+ "_" +j_room+ " class=meter-cubic total-amt><span class=total-amt>0.00</span> M<sup>3</sup></p>\n"+
                                    "</div>\n"+
                                    "<div data-role=content>\n"+
                                         "<div class=sub-header>\n"+
                                            "<h1 id=sub_header_title_"+crnt_room+"_"+j_room+"></h1>\n"+
                                         "</div>\n"+
                                         "<div class=types class=subheader-checklist>\n"+
                                            "<form class=mini id=all_chapter_articles_"+crnt_room+"_"+j_room+"></form>\n"+
                                         "</div>\n"+
                                    "</div>\n"+
                                    "<div data-role=footer data-position=fixed>\n"+
                                        "<button name=toNext id=toNext class='button-next toNext_"+crnt_room+"_"+j_room+"'>DONE</button>\n"+
                                    "</div>\n"+
                                    "<span id=popup_win_"+crnt_room+"_"+j_room+"></span>\n"+
                                "</div>");

                newPage.appendTo('body');

                var 
                     k_item     = 0
                    ,tmp_amt    = ""
                    ,tmp_popup_win  = ""
                    ,tmp_ckbx_item  = ""
                ;


                for (k_item ; k_item < gl_room_info[i_rooms].items.length ; k_item++) 
                {  
                    var 
                         tmp_item_id   = gl_room_info[i_rooms].items[k_item].item_id
                        ,tmp_item_name = gl_room_info[i_rooms].items[k_item].item_name
                        ,tmp_item_volume = gl_room_info[i_rooms].items[k_item].volume
                        ,tmp_description = gl_room_info[i_rooms].items[k_item].description
                        ,tmp_room_name = gl_room_info[i_rooms].room_name
                        ,tmp_item_room_id  = tmp_item_id+"_"+j_room+"_"+k_item
                    ;

                    gl_item_room_id_collector.push({
                                                    item_room_id : tmp_item_room_id,
                                                    item_name    : tmp_item_name,
                                                    item_volume  : tmp_item_volume,
                                                    item_id      : tmp_item_id,
                                                    room_id      : crnt_room,
                                                    room_name    : tmp_room_name,
                                                    room_number  : j_room,
                                                    room_sort    : i_rooms,
                                                    item_number  : k_item,
                                                    volume       : 0
                                                 });


                     tmp_ckbx_item +=   " <input type='checkbox' name="+tmp_item_name+"\n"+                    
                                        " onClick='f_checkbox_articles(this.value)'\n"+
                                        " id='checkbox-"+tmp_item_room_id+"'\n"+
                                        " value="+tmp_item_room_id+">\n"+
                                        " <label for='checkbox-"+tmp_item_room_id+"' id='label-"+tmp_item_room_id+"'>\n"+  
                                        " <ul style='vertical-align:middle;  display:inline-block;\n";
                                        if(tmp_description == null) 
                                        {
                                           tmp_ckbx_item += " list-style-type:none; padding-left: 10px;'><li style='margin-top: 5px;'>"+tmp_item_name +"</li>\n"+ 
                                                            " <li class='desc hide'>"+tmp_description+"</li></ul>\n";
                                        }
                                        else 
                                        {
                                            tmp_ckbx_item += " list-style-type:none; padding-left: 10px;'><li >"+tmp_item_name +"</li>\n"+
                                                             " <li class=desc>"+tmp_description+"</li></ul>\n";
                                        }
                    tmp_ckbx_item +=    " <ul id=amt-vol style='float:right; opacity:0.7; color:#0289cc; font-size:13px; display: inline-block; list-style-type:none;'>\n"+
                                        " <li id='amt-"+tmp_item_room_id+ "'>Amount: 0.00</li>\n"+
                                        " <li id='vol-"+tmp_item_room_id+"'>Volume:  0.00</li></ul></label>";    


                    tmp_popup_win += " <div data-role='popup' data-dismissible=false id='popup-num-rooms-"+tmp_item_room_id+"'\n"+ 
                                     " style='max-width: 100%;'><div data-role='content'>\n"+
                                     " <h4 id='popup-header-"+tmp_item_room_id+"'></h4><form name= 'form_pop_"+tmp_item_room_id+"'>\n"+
                                     " <select name='get-amt-"+tmp_item_room_id+"'\n"+
                                     " id='get-amt-"+tmp_item_room_id+"'>\n"+
                                     " </select></form><button type='submit' onClick='f_btn_ok_popup(this.value)' value= "+tmp_item_room_id+"\n"+ 
                                     " name='set-amt-"+tmp_item_room_id+"' id='set-amt-"+tmp_item_room_id+"'\n"+ 
                                     " form='form_pop_"+tmp_item_room_id+"' >OK</button></div></div>";

                }

                $("#all_chapter_articles_" + crnt_room + "_" + j_room).html(tmp_ckbx_item);

                $("#popup_win_" + crnt_room + "_" + j_room).html(tmp_popup_win);

                $("#sub_header_title_" + crnt_room + "_" + j_room).html(gl_room_info[i_rooms].room_name+ ": " + j_room);
                
                // BUTTON TEXT
                if ((j_room) < rooms_to_create) 
                {
                    var tmp_crnt_room_name = gl_room_info[i_rooms].room_name;

                    // change button text                          
                    $("."+"toNext_"+crnt_room+"_"+j_room).html("Next to "+tmp_crnt_room_name+" "+(j_room+1));
                }   
                
//                // if it's the last room GO IN
                if (j_room == rooms_to_create)
                {
                    var 
                         tmp_next_index = i_rooms +1
                        ,found_index = false
                    ;
                
                    while ((!found_index) && (tmp_next_index < number_of_total_rooms))
                    {
                        if (arrRooms1[gl_room_info[tmp_next_index].room_id] > 0)
                        {
                            var tmp_crnt_room_name = gl_room_info[tmp_next_index].room_name;
                            $(".toNext_"+crnt_room+"_" +j_room).html("Next to "+tmp_crnt_room_name +" 1");
                            found_index = true;
                        }
                        tmp_next_index++;
                    }
                }
            }
			f_set_checkbox_articles(gl_item_room_id_collector);
        }
        
        // set all header names of popup window
        for(var i_header = 0; i_header < gl_item_room_id_collector.length; i_header++)
        {
            $("#popup-header-"+gl_item_room_id_collector[i_header].item_room_id).html(gl_item_room_id_collector[i_header].item_name);
        }
    }
};
   
f_create_room_pages();
        
var quotePage = $(
          "<div data-role=page data-url=quote>\n"+
            "<div data-role=header data-theme=b data-position=fixed data-id=footer>\n"+
                "<p class=header-checklist>Volume calculator and checklist</p>\n"+
                "<p id=amount class=meter-cubic><span class=total-amt>0.00</span> M<sup>3</sup></p>\n"+
            "</div>\n"+
            "<div data-role=content>\n"+
                "<div class=sub_header><h1 id=sub_header_title-quote>Get A Quote</h1>\n"+
                "</div>\n"+
                "<div class=types class=subheader-checklist><span id=quote_form></span>\n"+
                "</div>\n"+
            "</div>\n"+
         "</div>"
         );

quotePage.appendTo('body');

$.support.cors = true;
$.mobile.allowCrossDomainPages = true;
$.mobile.pushStateEnabled = false;

$(document).ready(function () 
{
	var error = [0, 0, 0, 0, 0, 0];

    $('#btn_submit_quote').click(function () 
    {
		
		if($('#full_name').val() == '')  {
			$('#full_name').parent().css({"border-color": "#ff0000"});
			error[0] = 1;
		}
		else {
			$('#full_name').parent().css({"border-color": "#ddd"});
			error[0] = 0;
		}
		if($('#phone').val() == '')  {
			$('#phone').parent().css({"border-color": "#ff0000"});
			error[1] = 1;
		}
		else {
			$('#phone').parent().css({"border-color": "#ddd"});
			error[1] = 0;
		}
		if($('#email').val() == '')  {
			$('#email').parent().css({"border-color": "#ff0000"});
			error[2] = 1;
		}
		else {
			if($('#email').val() !== $('#confirm-email').val())  {
				$('#email').parent().css({"border-color": "#ff0000"});
				$('#confirm-email').parent().css({"border-color": "#ff0000"});
				error[3] = 1;
			}
			else {
				$('#email').parent().css({"border-color": "#ddd"});
				$('#confirm-email').parent().css({"border-color": "#ddd"});
				error[3] = 0;
			}
			$('#email').parent().css({"border-color": "#ddd"});
			error[2] = 0;
		}
		
		if($('#pickup').val() == '')  {
			$('#pickup').parent().css({"border-color": "#ff0000"});
			error[4] = 1;
		}
		else {
			$('#pickup').parent().css({"border-color": "#ddd"});
			error[4] = 0;
		}
		if($('#delivery').val() == '')  {
			$('#delivery').parent().css({"border-color": "#ff0000"});
			error[5] = 1;
		}
		else {
			$('#delivery').parent().css({"border-color": "#ddd"});
			error[5] = 0;
		}
		if(error.indexOf(1) > -1) {
			return false;
		}
		
			var data = 
			{
				"input_values": 
				{
					"input_10": $('#find_us').val(),
					"input_2": $('#full_name').val(),
					"input_3": $('#phone').val(),
					"input_5": $('#email').val(),
					"input_11": $('#region').val(),
					"input_12": $('#pickup').val(),
					"input_13": $('#delivery').val(),
					"input_8": $('#notes').val(),
					"input_9": $('#listing').val(),
					"input_6": gl_amt_volume
				}
			};

			var url = 'http://www.movinghouseapps.co.nz/gravityformsapi/forms/2/submissions/';
			var xmlrequest = new XMLHttpRequest();
			xmlrequest.open('POST', url, true);
			xmlrequest.send(JSON.stringify(data));
			xmlrequest.onreadystatechange = function() 
			{
				if (xmlrequest.readyState == 4) 
				{
					if(xmlrequest.status == 200 || xmlrequest.status == 0) 
					{
						window.location = "estimator.html";
					}
				}
			};
    });
});


var	tmp_quote  = "<form class='mini quote'><label for=find-us>How did you find us?</label><select data-id=10 name=find-us id=find_us>\n"+
                 "<option value=Google>Google</option><option value=Customer>I'm a customer</option><option value=Friend>Referred by a Friend</option>\n"+
                 "<option value=Social-Media>Social Media, Facebook etc.</option><option value=TradeMe>TradeMe</option><option value=Yellow>\n"+
                 "Yellow, Finda, Localist</option><option value=Truck>Our Trucks and Vans</option>\n"+
                 "<option value=Others>Others</option></select><br />\n"+
                 "<label for=full_name>Full Name*</label>\n"+"<input data-id=2 type=text name=full_name id=full_name><br />\n"+
                 "<label for=phone>Phone*</label><input data-id=3 type=number name=phone id=phone><br />\n"+
                 "<label for=email>Email*</label><input data-id=5 type=email name=email id=email><br />\n"+
                 "<label for=confirm-email>Confirm Email*</label><input type=email name=confirm-email id=confirm-email><br />\n"+
                 "<label for=region>Region</label><select data-id=11 name=region id=region><option value=Auckland>Auckland</option>\n"+
                 "<option value=Northland>Northland</option><option value=Coromandel>Coromandel</option>\n"+
                 "<option value=Waikato>Waikato</option><option value=Bay-of-Plenty>Bay of Plenty</option>\n"+
                 "<option value=East-Coast>East Coast</option><option value=Central-Plateau>Central Plateau</option>\n"+
                 "<option value=Manawatu-Wanganui>Manawatu - Wanganui</option><option value=Wairarapa>Wairarapa</option>\n"+
                 "<option value=Wellington>Wellington</option> <option value=Nelson>Nelson</option>\n"+
                 "<option value=Marlborough>Marlborough</option><option value=West-Coast>West Coast</option>\n"+
                 "<option value=Canterbury>Canterbury</option><option value=Otago>Otago</option><option value=Fiordland>Fiordland</option>\n"+
                 "<option value=Southland>Southland</option></select><br />\n"+
                 "<label for=pickup>Pickup Address*</label><input data-id=12 type=text name=pickup id=pickup><br />\n"+
                 "<label for=delivery-name>Delivery Address*</label><input data-id=13 type=text name=delivery id=delivery><br />\n"+
                 "<label for=notes>Notes</label><textarea data-id=8 name=notes id=notes placeholder='Tell us about access, heavy items, extra listings, etc.'></textarea><br />\n"+
				 "<label for=listing>Listing</label><textarea data-id=9 name=listing id=listing style=display:block;></textarea><br />\n"+
                 "<button id=btn_submit_quote>GET A QUOTE</button></form>"
;

$("#quote_form").html(tmp_quote);
			
</script>
    
</head>
<body>
    <div  id="aside_estimator"> </div>
</body>
</html>